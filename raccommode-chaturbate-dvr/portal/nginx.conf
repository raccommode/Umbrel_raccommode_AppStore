server {
  listen 80;
  server_name _;

  # Serve the portal homepage
  root /usr/share/nginx/html;
  index index.html;

  # Simple headers
  add_header X-Content-Type-Options nosniff;
  add_header Access-Control-Allow-Origin *;

  # Videos browser
  location /videos/ {
    alias /usr/share/nginx/html/videos/;
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;
    add_header Cache-Control "no-cache";

    types {
      text/plain log;
      video/mp4 mp4;
      video/mp2t ts;
      application/vnd.apple.mpegurl m3u8;
      video/webm webm;
      video/ogg ogg;
      video/x-matroska mkv;
      application/octet-stream mkv;
    }
  }

  # Proxy the original DVR UI under /dvr/
  location /dvr/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 600;
    proxy_send_timeout 600;
    proxy_buffering off;
    proxy_redirect off;

    # Important: keep trailing slash so relative paths work
    proxy_pass http://web:8080/;

    # Attempt to rewrite absolute asset paths used by the upstream UI
    sub_filter_types text/html text/css application/javascript;
    sub_filter_once off;
    sub_filter 'href="/' 'href="/dvr/';
    sub_filter 'src="/' 'src="/dvr/';
    sub_filter 'action="/' 'action="/dvr/';
  }

  # Default routing
  location / {
    try_files $uri $uri/ /index.html;
  }
}
